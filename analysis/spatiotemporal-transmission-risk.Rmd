---
title: "Spatiotemporal transmission risk"
author: "Nicolas Banholzer"
date: "2022-11-25"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(dplyr.summarise.inform = FALSE)
```

## Libraries

```{r}
library(tidyverse)
library(reshape2)
library(rriskDistributions)
library(tidybayes)
library(lubridate)
library(sf)
library(raster)
library(terra)
library(ggridges)
library(grid)
library(ggplot2)
library(ggrepel)

source("../utils/distr.r")
source("../utils/trans_risk.r")
source("../utils/spatial.r")
source("../utils/plotting.R")

# plot with and height of input and data graphs
aw <- 12
ah <- 8
```


## Data

### Clinical

```{r}
clinical_dta <- readRDS("../data-clean/Masi/clinical-data/clinical-data.rds")
share_tb <- clinical_dta %>%
  group_by(date, patient_id) %>%
  summarize(tb = any(tb_suspect == "yes")) %>%
  ungroup() %>%
  group_by(date) %>%
  summarize(n = n(),
            n_tb = sum(tb)) %>%
  arrange(date) %>%
  mutate(prop_tb = n_tb / n * 100,
         date = format(date, format = "%b %d"),
         date = factor(date, levels = unique(date))) %>%
  ungroup() 
share_tb_pl <- share_tb %>%
  ggplot(aes(x = date, y = n_tb)) +
  geom_bar(stat = "identity", fill = "grey", color = "black", width = .5) +
  annotate("text", x = "Nov 09", y = mean(share_tb$n_tb), label = paste0("Mean = ",round(mean(share_tb$n_tb), 1)), color = "darkred", size = 8 / cm(1), vjust = -1) +
  geom_hline(aes(yintercept = mean(share_tb$n_tb)), color = "darkred") +
  scale_y_continuous(expand = expansion(mult = c(0,0.05))) +
  scale_x_discrete(breaks = c("Oct 11", "Oct 18", "Oct 25", "Nov 02", "Nov 09", "Nov 16")) +
  labs(y = "No. of TB patients") +
  theme_bw2() +
  theme(axis.title.x = element_blank(),
        plot.margin = margin(5.5, 10, 5.5, 5.5))
save_plot(share_tb_pl, pdf_file = "../results/data/share-tb-patients.pdf", w = aw, h = ah)
```

### CO2

```{r}
co2_pl <- readRDS("../data-clean/Masi/environmental-data/co2-temp-humid.rds") %>%
  filter(location %in% c("waiting room", "tb room")) %>%
  mutate(location = factor(ifelse(location == "tb room", "TB room", "Waiting room"), levels = c("Waiting room", "TB room")),
         time = as.POSIXct(time, format = "%H:%M", tz = "CET")) %>%
  ggplot(aes(x = time, y = co2, color = location, fill = location)) +
  stat_lineribbon(alpha = .25, size = .5) +
  scale_x_datetime(expand = c(0,0), date_breaks = "2 hours", date_labels = "%H:%M") +
  scale_y_continuous(expand = c(0,0), breaks = scales::breaks_width(width = 100)) +
  scale_fill_brewer(palette = "Accent") +
  scale_color_brewer(palette = "Accent") +
  labs(y = expression("CO"[2]*" (ppm)"), fill = "Quantile", color = "Quantile") +
  theme_bw2() +
  theme(legend.position = c(.8,.95), legend.direction = "horizontal", legend.key.width = unit(0.3, "cm"), legend.key.height = unit(0.2, "cm"),
        plot.margin = margin(5.5, 10, 5.5, 5.5), axis.title.x = element_blank(), legend.title = element_blank()) 
save_plot(co2_pl, pdf_file = "../results/data/co2-levels.pdf", w = aw, h = ah)
```

### Building

```{r}
# background image
clinic_img <- png::readPNG("../data-raw/Masi/building/clinic_clipped.png")
```


<!-- ```{r} -->
<!-- # choose cell size such that the squared cell has 1m3 volume -->
<!-- cellVolume <- 1 -->
<!-- cellSize <- sqrt(cellVolume * 1e9 / 3e3)  -->

<!-- # waiting room -->
<!-- sh_wr <- vect("../data-raw/Masi/building/waiting_room.shp") -->
<!-- sf_wr <- st_as_sf(sh_wr) -->
<!-- wrRoomSP <- shapeToSpatial(sh_wr, cellSize) -->
<!-- wrVol <- compute_volume(wrRoomSP) -->
<!-- wrCellCoords <- create_coord_df(wrRoomSP) -->
<!-- wrRoomXY <- as.matrix(dplyr::select(wrCellCoords, x, y)) -->

<!-- # tb room -->
<!-- sh_tb <- vect("../data-raw/Masi/building/tb_room.shp") -->
<!-- sf_tb <- st_as_sf(sh_tb) -->
<!-- tbRoomSP <- shapeToSpatial(sh_tb, cellSize) -->
<!-- tbVol <- compute_volume(tbRoomSP) -->
<!-- tbCellCoords <- create_coord_df(tbRoomSP) -->
<!-- tbRoomXY <- as.matrix(dplyr::select(tbCellCoords, x, y)) -->

<!-- # passage -->
<!-- sh_pa <- vect("../data-raw/Masi/building/passage.shp") -->
<!-- sf_pa <- st_as_sf(sh_pa) -->
<!-- paRoomSP <- shapeToSpatial(sh_pa, cellSize) -->
<!-- paVol <- compute_volume(paRoomSP) -->
<!-- paCellCoords <- create_coord_df(paRoomSP) -->
<!-- paRoomXY <- as.matrix(dplyr::select(paCellCoords, x, y)) -->

<!-- # combine -->
<!-- clinicCellCoords <- rbind( -->
<!--   mutate(wrCellCoords, location = "waiting room"), -->
<!--   mutate(tbCellCoords, location = "tb room"), -->
<!--   mutate(paCellCoords, location = "passage") -->
<!-- ) %>% mutate(id = 1:nrow(.)) -->
<!-- clinicCellCoordsXY <- cbind(clinicCellCoords$x, clinicCellCoords$y) -->
<!-- ``` -->


### No. people

```{r}
files <- list.files("../data-clean/Masi/patient-tracking-data/", full.names = T)
no_people <- do.call(rbind, lapply(files, function(x) readRDS(paste0(x, "/patient-id-data.rds")))) %>%
  mutate(date = format(time, format = "%Y-%m-%d"),
         time = as.POSIXct(time, format = "%H:%M", tz = "CET"),
         daytime = ifelse(time <= "2021-10-25 12:00:00", "Morning", "Afternoon"),
         daytime = factor(daytime, levels = c("Morning", "Afternoon"))) 

# over time
no_people_time_pl <- no_people %>%
  group_by(date, time) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  ggplot(aes(x = time, y = n)) +
  geom_line() +
  #stat_lineribbon(alpha = .25, size = .5) +
  scale_x_datetime(expand = c(0,0), date_breaks = "2 hours", date_labels = "%H:%M") +
  scale_y_continuous(expand = c(0,0), limits = c(0, NA), breaks = scales::breaks_width(5)) +
  scale_fill_brewer(palette = "OrRd") +
  labs(y = "No. of clinical attendees") +
  theme_bw2() +
  theme(axis.title.x = element_blank())
  #labs(y = "No. of clinical attendees", fill = "Quantile", color = "Quantile") +
  # theme(legend.position = c(.8,.9), legend.direction = "horizontal", legend.key.width = unit(0.3, "cm"), legend.key.height = unit(0.2, "cm"),
  #       plot.margin = margin(5.5, 10, 5.5, 5.5)) +
  # guides(fill = guide_legend(title.position = "top"))
save_plot(no_people_time_pl, pdf_file = "../results/data/no-people-over-time.pdf", w = aw, h = ah)

# Spatial
no_people_spatial_pl <- no_people %>%
  dplyr::select(x, y) %>%
  adespatial::rotation(angle = -8*pi/180) %>%
  as.data.frame() %>%
  set_names(c("x", "y")) %>%
  mutate(x = -x) %>%
  ggplot(aes(x = x, y = y)) +
  geom_bin2d(binwidth = 100) +
  ggpubr::background_image(clinic_img) +
  annotate("text", x = -13200, y = -5300, label = "Entrance", size = 8 / cm(1), fontface = 2, hjust=0,vjust=0) +
  annotate("text", x = -13400, y = -2300, label = "Waiting room", size = 8 / cm(1), fontface = 2, hjust=0,vjust=0) +
  annotate("text", x = -5000, y = -4100, label = "Registration", size = 8 / cm(1), fontface = 2, angle = 90, hjust=0,vjust=0) +
  annotate("text", x = 2600, y = -2700, label = "TB room", size = 8 / cm(1), fontface = 2) +
  scale_fill_stepsn(colours = RColorBrewer::brewer.pal(n = 9, name = "YlOrRd")[c(1,3,5,7,9)], breaks = c(1,5,10,50,100), limits = c(0,100)) +
  scale_y_continuous(expand = expansion(mult = c(0,.18))) +
  scale_x_continuous(expand = expansion(mult = c(0,0.025))) +
  labs(fill = "Density") +
  theme(axis.text = element_blank(), axis.title = element_blank(), axis.ticks = element_blank(),
        legend.position = c(0.825,0.075), legend.direction = "horizontal", legend.title = element_blank(), #legend.title = element_text(vjust = .75),
        panel.background = element_rect(fill = RColorBrewer::brewer.pal(n = 3, name = "YlOrRd")[1]), panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())
save_plot(no_people_spatial_pl, pdf_file = "../results/data/no-people-spatial.pdf", w = aw, h = ah)
```

<!-- ```{r} -->
<!-- # number of people in space -->
<!-- nDF <- tibble() -->
<!-- for (tp in time_period) { -->
<!--   n_tp <- clinXov %>% -->
<!--     filter(between(time, tp, tp + seconds(59))) %>% -->
<!--     mutate(location = mapply(function(x,y) clinicCellCoords$location[find_raster(x,y,clinicCellCoordsXY)], x, y)) %>% -->
<!--     group_by(person_id, location) %>% -->
<!--     slice(1) %>% -->
<!--     ungroup() %>% -->
<!--     group_by(location) %>% -->
<!--     summarize(n = n()) %>% -->
<!--     ungroup()  -->
<!--   for (loc in unique(clinicCellCoords$location)) { -->
<!--     if (!(loc %in% n_tp$location)) { -->
<!--       n_tp <- rbind(n_tp, data.frame(location = loc, n = 0)) -->
<!--     }  -->
<!--   } -->
<!--   nDF <- rbind(nDF, n_tp %>% mutate(time = tp)) -->
<!-- } -->
<!-- nDF <- nDF %>%  -->
<!--   mutate(time = as.POSIXct(time, origin = as.Date("1970-01-01"))) -->
<!-- nDF$n[nDF$location=="waiting room"] <- nDF$n[nDF$location=="waiting room"] + nDF$n[nDF$location=="passage"] -->
<!-- nDF$n[nDF$location=="passage"] <- nDF$n[nDF$location=="waiting room"] + nDF$n[nDF$location=="passage"] -->
<!-- ggplot(nDF, aes(x = time, y = n, color = location)) + geom_line() -->
<!-- ``` -->


<!-- ### Movement -->

<!-- ```{r} -->
<!-- patMov <- clinXov %>% -->
<!--   mutate(id = map2_int(x, y, find_raster, cellCoordsXY = clinicCellCoordsXY)) -->
<!-- ``` -->


## Assumptions

```{r}
n_samples <- 1000
set.seed(12345)
```

### Spatial emission

* Wang (2021): 
  * Travel distance of particles depends on particle size, activity, and environmental factors
  * Smaller aerosols can travel further, stay in the air for a longer time, and typically contain higher viral load
  * The concentration of exhaled aerosols is highest close to the source and decreases with distance
  * Short-range aerosol transmission difficult to prevent with ventilation
* Chen (2020): Short-range aerosols dominate over most distance up to 2m, droplets only play a role at very close distance <0.5
* Ko (2004): exponential decrease of potential infections on an airplance (high ventilation) with distance to infector


--> Assume an exponential decrease in viral concentration with distance to source relative to the source (relative concentration = 1). 


```{r}
relQC_pl <- expand.grid(distance = seq(0, 10, .1), 
                           mu = rMuIc(n_samples)) %>%
  mutate(relQC = dIc(distance, mu) * 100) %>%
  ggplot(aes(x = distance, y = relQC)) +
  stat_lineribbon(alpha = .5, size = .5) +
  scale_x_continuous(expand = c(0,0)) +
  scale_y_continuous(expand = c(0,0)) +
  scale_fill_brewer(palette = "OrRd") +
  labs(x = "Distance (m)", y = "Relative quanta concentration (%)", fill = "Quantile") +
  theme_bw2() +
  theme(legend.position = c(.8,.9), legend.direction = "horizontal", legend.key.width = unit(0.3, "cm"), legend.key.height = unit(0.2, "cm"),
        plot.margin = margin(5.5, 10, 5.5, 5.5)) +
  guides(fill = guide_legend(title.position = "top"))
save_plot(relQC_pl, pdf_file = "../results/inputs/spatial-relative-quanta-concentration.pdf", w = aw, h = ah)
```


### Infectious quanta 

* Riley (1962): 130 patients, q: 1.25
* Escombe (2008): 117 patients, q: 8.2; but high values above 100 are possible
* Nardell (1991) : 1 patients, q: 12.5
* Andrews (2014) : 571 patients, q: 0.89

--> Take the mean and standard deviation of these values and use a student-t distribution with small degrees of freedom to consider outliers

```{r}
q <- c(1.25, 8.2, 12.5, 0.89)
n_q <- c(130, 117, 1, 571)
mean_q <- sum(n_q * q) / sum(n_q)
sd_q <- sqrt( sum( (n_q / sum(n_q) * (q - mean_q) ^ 2 ) ) )

qLiterature <- data.frame(q = q, 
                          y = .01, 
                          lab = c("Riley", "Escombe", "Nardell", "Andrews"))

q_pl <- data.frame(q = seq(0, 40, .1)) %>%
  mutate(density = dq(q)) %>%
  ggplot(aes(x = q, y = density)) +
  geom_line() +
  geom_vline(mapping = aes(xintercept = 2), linetype = "dashed", color = "darkred") +
  annotate("text", x = 3, y = 0.175, hjust = 0, label = "Mean = 2.0", size = 8 / cm(1), color = "darkred") +
  geom_point(data = qLiterature, mapping = aes(x = q, y = y, color = lab, shape = lab)) +
  geom_text_repel(data = qLiterature, mapping = aes(x = q, y = y, color = lab, label = lab), size = 8 / cm(1)) +
  annotate("text", x = 30, y = 0.175, label = expression("q ~ Student-t("*mu*"=2.0,"*sigma*"=2.5"*","*nu*"=1)"), size = 8 / cm(1)) +
  scale_x_continuous(expand = c(0,0), limits = c(0, 40)) +
  scale_y_continuous(expand = expansion(mult = c(0,0.05))) +
  scale_color_brewer(palette = "Dark2", direction = -1) +
  labs(x = "Quanta emission (log q/h)", y = "Density") +
  theme_bw2() +
  theme(plot.margin = margin(5.5, 10, 5.5, 5.5), legend.position = "none")
save_plot(q_pl, pdf_file = "../results/inputs/quanta-emission.pdf", w = aw, h = ah)
```


### Unmasked TB patients

* Berhanu (2023): 
  * study group: clinic attendees living with HIV, contact with TB patients in past year, or had TB in the past 2 years
  * finding: 55% of  with a sputum result positive for M. tuberculosis did not have a positive TB symptom screen
* Hamada (2018): The WHO 4-question symptom screen (cough, fever, weight loss, and night sweats) misses up to half the TB cases among people living with human immunodeficiency virus (HIV) on antiretroviral therapy (ART)
--> Unmasked TB patients: Poisson(mu = No. of TB suspects)

```{r}
unmaskedTB <- data.frame(n_tb = share_tb$n_tb) %>%
  mutate(unmasked_tb = lapply(n_tb, function(x) rTBunmasked(n = n_samples, lambda = x))) %>%
  unnest(unmasked_tb) %>%
  group_by(unmasked_tb) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  mutate(prop_unmasked_tb = n / sum(n)) 
mean_unmaskedTB <- sum(unmaskedTB$unmasked_tb * unmaskedTB$prop_unmasked_tb)
unmaskedTB_pl <- unmaskedTB %>%
  ggplot(aes(y = prop_unmasked_tb, x = unmasked_tb)) +
  geom_bar(stat="identity", fill = "grey", color = "black") +
  geom_vline(mapping = aes(xintercept = mean_unmaskedTB), linetype = "dashed", color = "darkred") +
  annotate("text", y = 0.25, x = mean_unmaskedTB, hjust = -.2, label = paste0("Mean = ", round(mean_unmaskedTB, 1)), size = 8 / cm(1), color = "darkred") +
  scale_y_continuous(expand = expansion(mult = c(0,0.05))) +
  scale_x_continuous(expand = c(0,0)) +
  labs(x = "No. of unmasked TB patients", y = "Probability (%)") +
  theme_bw2()
save_plot(unmaskedTB_pl, pdf_file = "../results/inputs/unmasked-tb-patients.pdf", w = aw, h = ah)
```


### Ventilation 

Average volume of exhaled gas:
* Richardson et al. (2014): 0.1 - 0.17 l/s per person based on Feher (2017)
--> Use Uniform(0.1, 0.17)

CO2 levels in outdoor air:
* https://gml.noaa.gov/dv/data/index.php?site=CPT&parameter_name=Carbon%2BDioxide,%20accessed%2012%20November%202019
--> Set to 4125.5

CO2 levels in exhaled air:
* Rudnick and Milton (2003): 40,000
--> Set to 40,000

CO2 generation rate
* Persily et al.: see Table 5, around 0.003 to 0.005
--> Use Uniform(0.003, 0.005)



### Inactivation

* Nardell (2016) reviews Loudon et al. (1969) and Lever et al. (2000) reporting contradictory findings of half-lives between 20m to 6h. Exact viability in the air is unknown.
* The finding by Lever et al. would suggest that sustained contact is required for transmission.
* The viability in the air probably depends a lot on the conditions, in particular ventilation and UV.  

--> TODO: Check how high the ventilation rate is compared to half-lives as to whether we can ignore the half-lives.


### Deposition onto surfaces

* Wang et al. (2021): The larger the size of the particle, the less long it will reside in the air. Environmental factors such as temperature, humidity and ventilation also play an important role.


## Simulation

```{r}
# Settings
set.seed(12345)
nSim <- 100

# Input parameters
inputPar <- data.frame(
  spatial_mu = rMuIc(nSim),
  quanta = rq(nSim),
  V = rV(nSim),
  co2_ex = co2_exhaled,
  co2_out = min(co2$co2),
  co2_gen = rG(nSim),
  unmasked_TB = rTBunmasked(nSim, nTBmasked)
)

# Loop
for (s in 1:nSim) {
  message(sprintf("Simulation %i of %i", s, nSim))
  
  # parameters
  smu <- inputPar$spatial_mu[s]
  q <- inputPar$quanta[s]
  V <- inputPar$V[s]
  Ca <- inputPar$co2_ex[s]
  Co <- inputPar$co2_out[s]
  G <- inputPar$co2_gen[s]
  unmasked_TB <- inputPar$unmasked_TB[s]
  
  # transformed parameters
  # quanta emission rate per minute
  ER <- q / 60
  
  # TB patients
  masked_tb <- yesTB$person_id
  unmasked_tb <- sample(noTB$person_id, size = unmasked_TB)
  TBpatients <- patMov %>%
    filter(person_id %in% c(masked_tb, unmasked_tb)) %>%
    dplyr::select(person_id, observation_id, time, x, y) 
  TBpatients_full <- TBpatients %>%
    group_by(person_id) %>%
    summarize(time = list(seq(min(time), max(time), by = "sec"))) %>%
    ungroup() %>%
    unnest(cols = c(time))
  TBpatients_full <- TBpatients_full %>%
    left_join(TBpatients, by = c("person_id", "time")) %>%
    tidyr::fill(observation_id, x, y, .direction = "down")
  
  # no TB patients
  noTBpatients <- patMov %>%
    filter(!(person_id %in% c(masked_tb, unmasked_tb))) %>%
    dplyr::select(person_id, time, id) 
  noTBpatients_full <- noTBpatients %>%
    group_by(person_id) %>%
    summarize(time = list(seq(min(time), max(time), by = "sec"))) %>%
    ungroup() %>%
    unnest(cols = c(time))
  noTBpatients_full <- noTBpatients_full %>%
    left_join(noTBpatients, by = c("person_id", "time")) %>%
    tidyr::fill(id, .direction = "down") %>%
    mutate(time = as.POSIXct(format(time, "%Y-%m-%d %H:%M"))) %>%
    group_by(person_id, id, time) %>%
    summarize(minutes = n() / 60) %>%
    ungroup()
    
  
  # df to store quanta concentration by minute
  quantaDF <- clinicCellCoords %>%
    mutate(time = time_period[1] - minutes(1),
           I_SP = 0,
           I_WM = 0,
           E_SP = 0,
           E_WM = 0,
           N_SP = 0,
           AER = NA,
           RR = NA,
           N_WM = 0,
           N_SP = 0) 
  
  for (t in 1:length(time_period)) {
    
    # time point
    tp <- time_period[t] 
    quantaDF_new <- clinicCellCoords %>%
      mutate(time = tp,
             I_SP = 0,
             I_WM = 0,
             E_SP = 0,
             E_WM = 0,
             N_SP = 0,
             N_WM = 0)
    
    # spatial spread of infectious individuals and quanta emission
    TBpatients_tp <- TBpatients_full %>%
      dplyr::filter(between(time, tp, tp + minutes(1)))
    if (nrow(TBpatients_tp) > 0) {
      TBpatients_tp <- TBpatients_tp %>%
        nest(data = -person_id)
      # iterate over patients
      for (p in 1:nrow(TBpatients_tp)) {
        # duration and location
        duration <- nrow(TBpatients_tp$data[[p]])
        xy <- TBpatients_tp$data[[p]] %>% dplyr::select(x, y) %>% slice(1) %>% unlist()
        # generated quanta by cell
        locationID <- find_raster(xy[1], xy[2], clinicCellCoordsXY)
        locationName <- clinicCellCoords$location[locationID]
        locationCellCoords <- filter(clinicCellCoords, location == locationName)
        locationShape <- if(locationName == "waiting room") {sf_wr} else if(locationName == "tb room") {sf_tb} else {sf_pa}
        cellInReach <- numeric(nrow(quantaDF_new))
        cellDistance <- numeric(nrow(quantaDF_new))
        isIinCell <- ifelse(quantaDF_new$location==locationName, 1, 0 )
        for (cell in 1:nrow(quantaDF_new)) {
          # if cell is in room/location
          if (quantaDF_new$location[cell] != locationName) {
            cellInReach[cell] <- 0
            cellDistance[cell] <- -999
          } else {
            # can aerosols travel to this cell?
            straight_line <- st_linestring(rbind(xy, c(quantaDF_new$x[cell], quantaDF_new$y[cell]))) 
            intersects <- st_difference(straight_line, locationShape)
            cellInReach[cell] <- ifelse(length(intersects) == 0, 1, 0)
            cellDistance[cell] <- convert_dist(st_length(straight_line))
          }
        }
        # proportion of infectious individuals per cell per minute
        distance_dens <- cellInReach * dIc(cellDistance, smu)
        quantaDF_new$I_SP <- quantaDF_new$I_SP + distance_dens / sum(distance_dens) * (duration / 60)
        quantaDF_new$I_WM <- quantaDF_new$I_WM + isIinCell / sum(isIinCell)
      }
      # quanta emission
      quantaDF_new$E_SP <- quantaDF_new$E_SP + ER * quantaDF_new$I_SP
      quantaDF_new$E_WM <- quantaDF_new$E_WM + ER * quantaDF_new$I_WM
    } 
    
    # compute air exchange rate and quanta removal
    Ct <- co2 %>%
      group_by(location) %>%
      # if CO2 is missing, take the last observed value
      filter(date_time <= tp) %>%
      arrange(desc(date_time)) %>%
      slice(1) %>%
      mutate(date_time = tp) %>%
      ungroup() %>%
      # add number of people
      left_join(filter(nDF, time == tp), by = c("date_time" = "time", "location")) %>%
      # add volume
      mutate(vol = ifelse(location == "tb room", tbVol, wrVol + paVol)) %>%
      # compute AER and RR per minute
      mutate(AER = compute_AER(G, Co, co2, n, vol),
             RR = compute_RR(AER) / 60) 
    quantaDF_new <- quantaDF_new %>% 
      left_join(Ct %>% dplyr::select(location, AER, RR), by = "location")
      
    # previous quanta concentration
    N0_SP <- quantaDF %>% 
      filter(time == tp - minutes(1)) %>%
      dplyr::select(N_SP) %>% unlist
    N0_WM <- quantaDF %>% 
      filter(time == tp - minutes(1)) %>%
      dplyr::select(N_WM) %>% unlist
    
    # compute quanta concentration
    quantaDF_new$N_SP <- pmap_dbl(list(E = quantaDF_new$E_SP, 
                                       RR = quantaDF_new$RR, 
                                       N0 = N0_SP,
                                       V = cellVolume), compute_Nt)
    quantaDF_new$N_WM <- pmap_dbl(list(E = quantaDF_new$E_WM, 
                                       RR = quantaDF_new$RR, 
                                       N0 = N0_WM,
                                       V = cellVolume), compute_Nt)
    
    # append new data
    quantaDF <- rbind(quantaDF, quantaDF_new)
  }
  
  # compute (spatio)temporal transmission risk for each individual
  risk_of_infection <- noTBpatients_full %>%
    left_join(quantaDF, by = c("id", "time")) %>%
    group_by(person_id) %>%
    summarize(exposure_time = sum(minutes),
              P_SP = 1-exp(-sum(N_SP * minutes)),
              P_WM = 1-exp(-sum(N_WM * minutes))) %>%
    ungroup()
  
  # compute average transmission risk
  sum_I <- data.frame(location = c("waiting room", "passage", "tb room"),
                      I = length(c(masked_tb, unmasked_tb))) 
  mean_n <- nDF %>% 
    group_by(location) %>%
    summarize(n = median(n) + 1) %>%
    ungroup()
  mean_f <- co2 %>%
    group_by(location) %>%
    summarize(f = (mean(co2) - Co) / Ca) %>%
    ungroup()
  risk_of_infection_av <- noTBpatients_full %>%
    left_join(quantaDF %>% dplyr::select(id, time, location), by = c("id", "time")) %>%
    group_by(person_id, location) %>%
    summarize(minutes = sum(minutes)) %>%
    ungroup() %>%
    left_join(sum_I, by = "location") %>%
    left_join(mean_n, by = "location") %>%
    left_join(mean_f, by = "location") %>%
    mutate(mu = f * I * ER * minutes / n) %>%
    group_by(person_id) %>%
    summarize(P_SS = 1 - exp(-sum(mu))) %>%
    ungroup()
  risk_of_infection <- risk_of_infection %>%
    left_join(risk_of_infection_av, by = "person_id")
  
  
  # save simulation
  saveRDS(quantaDF, paste0("../simulations/2021-10-25/sim-quanta", s, ".rds"))
  saveRDS(risk_of_infection, paste0("../simulations/2021-10-25/sim-transRisk", s, ".rds"))
}
```



## Evaluation

### TB risk

```{r}
# files
transRiskFiles <- list.files("../simulations/2021-10-25", full.names = T)
transRiskFiles <- transRiskFiles[grepl("transRisk", transRiskFiles)]

# read files
transRiskDF <- data.frame(file = transRiskFiles) %>%
  mutate(simulation = stringi::stri_extract(basename(file), regex = "\\d{1,4}"), 
         data = lapply(file, readRDS)) %>%
  unnest(cols = c(data))

# QQ Plot
transRiskDF_Q <- transRiskDF %>%
  dplyr::select(simulation, P_SP, P_WM) %>%
  melt("simulation") %>%
  group_by(simulation, variable) %>%
  summarize(quantile = seq(0.05, .95, 0.05),
            value = quantile(value, seq(0.05, 0.95, 0.05))) %>%
  ungroup()

transRiskDF_Q_av <- transRiskDF_Q %>%
  group_by(variable, quantile) %>%
  summarize(value = mean(value)) %>%
  ungroup()

transRiskDF_Q_av %>%
  ggplot(aes(x = quantile, y = value, color = variable)) +
  geom_line()

# average transmission risk across patients
average_tr <- transRiskDF %>%
  dplyr::select(simulation, P_SP, P_WM) %>%
  mutate(P_SP = P_SP * 100,
         P_WM = P_WM * 100) %>%
  melt("simulation") %>%
  group_by(simulation, variable) %>%
  summarize(`Mean` = mean(value),
            `Standard deviation` = sd(value),
            `Median` = median(value),
            `Tail risk (95%-Quantile)` = quantile(value, .95)) %>%
  ungroup() 

figA <- average_tr %>%
  rename(model = variable) %>%
  mutate(model = ifelse(model == "P_SP", "Spatiotemporal modeling", "Temporal modeling")) %>%
  melt(c("simulation", "model")) %>%
  ggplot(aes(x = value, y = model, fill = model, color = model)) +
  stat_dots(quantiles = 100) +
  facet_wrap(~ variable, scales = "free_x") +
  scale_color_manual(values = cbPalette[2:3]) +
  scale_fill_manual(values = cbPalette[2:3]) +
  labs(x = "Risk of infection (%)", 
       title = "Fig. 1a: Risk of infection across patients",
       subtitle = "Colored dots show individual simulation results.") +
  theme_bw2() +
  theme(legend.position = "top", axis.title.y = element_blank(), axis.text.y = element_blank(), legend.title = element_blank(),
        legend.justification='left', legend.direction='horizontal')

figA

average_tr %>%
  dplyr::select(-simulation) %>%
  group_by(variable) %>%
  median_qi() %>%
  mutate_if(is.numeric, round, 2)


figB <- transRiskDF %>%
  ggplot(aes(x = P_SP, y = P_WM)) +
  geom_point(shape = 1) +
  geom_abline(mapping = aes(intercept = 0, slope = 1), color = "red", linetype = "dashed") +
  annotate("richtext", x = 0.75, y = 0.82, 
           label = "<span style = 'background-color:#fff'>Perfect correlation</span>", 
           size = 8 / cm(1), color = "red", angle = 22, label.color = NA) +
  geom_smooth(method = "lm") +
  annotate("richtext", x = 0.85, y = 0.55, 
           label = "<span style = 'background-color:#fff'>Empirical correlation</span>", 
           size = 8 / cm(1), color = "blue", angle = 16, label.color = NA) +
  labs(x = "Risk of infection (%) with spatiotemporal modeling", 
       y = "Risk of infection (%) with temporal modeling",
       title = "Fig. 1b: Patient-specific risk of infection",
       subtitle = "One dot per patient and simulation. Dots off (on) the diagonal imply a (no) differing risk of infection by modeling.") +
  scale_x_continuous(expand = c(0,0), limits = c(0,1), label = function(x) x * 100) +
  scale_y_continuous(expand = c(0,0), limits = c(0,1), label = function(x) x * 100) +
  theme_bw2() +
  theme(plot.margin = unit(c(5.5, 7.5, 5.5, 5.5), "points"))

figB

ggsave("../results/model-comparison.png", grid.arrange(figA, figB, ncol = 1), width = 16 / cm(1), height = 16 / cm(1))

# visualization of spatial approach
transRriskSP_pl <- transRiskDF %>%
  mutate(P_SP = P_SP * 100) %>%
  ggplot(aes(x = P_SP, y = simulation)) + # , color = ..x..
  stat_dots(quantiles = 20, color = "black") +
  #scale_color_viridis() +
  labs(y = "Simulation", x = "Risk of infection (%)",
       title = "Figure 1: Risk of infection", subtitle = "Quantile distribution of patient-specific risk of infection (%) for each simulation") +
  scale_x_sqrt(limits = c(0,NA), expand = c(0,0)) +
  scale_y_discrete(expand = c(0,0)) +
  theme_bw2() +
  theme(legend.position = "none")

transRriskSP_pl


# low, medium, high risk
transRiskDF_cat <- transRiskDF %>%
  dplyr::select(simulation, P_SP, P_WM) %>%
  melt("simulation") %>%
  group_by(simulation, variable) %>%
  summarize(`Very low` = sum(value <= .01),
            Low = sum(value > .01 & value <= .05),
            Medium = sum(value > .05 & value <= .1),
            High = sum(value > .1 & value <= .5),
            `Very high` = sum(value > .5)) %>%
  ungroup()


figB <- transRiskDF_cat %>%
  rename(model = variable) %>%
  mutate(model = factor(ifelse(model == "P_SP", "Spatiotemporal modeling", "Temporal modeling"),
                        levels = c("Spatiotemporal modeling", "Temporal modeling"))) %>%
  melt(c("simulation", "model")) %>%
  group_by(model, variable) %>%
  summarize(value = mean(value)) %>%
  ungroup() %>%
  ggplot(aes(y = variable, fill = model, x = value)) +
  geom_bar(stat = "identity", position = position_dodge2()) +
  scale_x_log10(expand = c(0,0)) + 
  scale_fill_manual(values = cbPalette[c(2,1)]) +
  labs(title = "B | Average number of visitors by risk of infection",
       subtitle = "Number of visitors with very high (>50%), high (10-50%), medium (5-10%), low (1-5%), and very low (<1%) risk of infection.",
       x = "Number of visitors") +
  theme_bw2() +
  theme(legend.position = "top", legend.justification='left', legend.direction='horizontal',
        legend.title = element_blank(), legend.key.width = unit(2.5, "cm"),
        axis.title.y = element_blank(),
        plot.title.position = "plot")

figB

transRiskDF_cat_alt <- transRiskDF %>%
  dplyr::select(simulation, P_SP, P_WM) %>%
  melt("simulation") %>%
  group_by(simulation, variable) %>%
  summarize(Low = sum(value <= .1),
            Medium = sum(value > .1 & value <= .5),
            High = sum(value > .5)) %>%
  ungroup()

figB_alt <- transRiskDF_cat_alt %>%
  rename(model = variable) %>%
  mutate(model = factor(ifelse(model == "P_SP", "Spatiotemporal modeling", "Temporal modeling"),
                        levels = c("Spatiotemporal modeling", "Temporal modeling"))) %>%
  melt(c("simulation", "model")) %>%
  group_by(model, variable) %>%
  summarize(value = mean(value)) %>%
  ungroup() %>%
  ggplot(aes(y = variable, fill = model, x = value)) +
  geom_bar(stat = "identity", position = position_dodge2()) +
  scale_x_log10(expand = expansion(mult = c(0,.01))) + 
  scale_fill_manual(values = cbPalette[c(2,1)], breaks = c("Temporal modeling", "Spatiotemporal modeling")) +
  labs(title = "B | Estimated number of visitors by risk of infection",
       subtitle = "Average number of visitors with high (>50%), medium (10-50%), and low (<10%) risk of infection.",
       x = "Number of visitors") +
  theme_bw2() +
  theme(legend.position = c(0.675, 0.825), legend.justification='left', legend.direction='vertical',
        legend.title = element_blank(), legend.key.width = unit(1.5, "cm"),
        axis.title.y = element_blank(),
        plot.title.position = "plot")

figB_alt
```


### Quanta 

```{r}
# files
quantaFiles <- list.files("../simulations/2021-10-25", full.names = T)
quantaFiles <- quantaFiles[grepl("quanta", quantaFiles)]

# read files
quantaDF <- data.frame(file = quantaFiles) %>%
  mutate(simulation = stringi::stri_extract(basename(file), regex = "\\d{1,4}"), 
         data = lapply(file, readRDS)) %>%
  unnest(cols = c(data))

# average quanta concentration
quantaDF_av <- quantaDF %>%
  filter(location == "waiting room") %>%
  # mutate(daytime = ifelse(time <= "2021-10-25 11:00:00", "Morning", 
  #                         ifelse(time <= "2021-10-25 13:00:00", "Noon", "Afternoon"))) %>%
  mutate(daytime = ifelse(time <= "2021-10-25 12:00:00", "Morning", "Afternoon")) %>%
  group_by(daytime, id) %>%
  summarize(N_SP = mean(N_SP)) %>%
  ungroup()

wrRoomSP_df <- fortify(wrRoomSP) %>%
  left_join(quantaDF_av %>% mutate(id = as.character(id)), by = "id") 

figA <- wrRoomSP_df %>%
  # mutate(daytime = factor(daytime, c("Morning", "Noon", "Afternoon"))) %>%
  mutate(daytime = factor(daytime, c("Morning", "Afternoon"))) %>%
  ggplot(aes(x = lat, y = long, group = group, fill = N_SP)) +
  geom_polygon() +
  facet_wrap(~ daytime) +
  scale_fill_gradient(low = "yellow", high = "red", na.value = NA) +
  labs(title = "A | Estimated spatiotemporal quanta concentration in the clinic by daytime",
       # subtitle = "Quanta concentration (quanta/m3) in the morning (7:30 to 11am), noon (11am to 1pm), and afternoon (1 to 4pm).") +
       subtitle = "Average quanta concentration (quanta/m3) in the morning (7:30 to 12am) and afternoon (12am to 4pm).") +
  geom_path(color = "white", size = 0.2) +
  theme_bw2() +
  theme(axis.title = element_blank(), axis.text = element_blank(),
        legend.position = "top", legend.justification='left', legend.direction='horizontal',
        legend.title = element_blank(), legend.key.width = unit(2.5, "cm"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank())

figA

ggsave("../results/model-comparison.png", grid.arrange(figA, figB_alt, ncol = 1), width = 16 / cm(1), height = 16 / cm(1))
```

