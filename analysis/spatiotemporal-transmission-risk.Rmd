---
title: "Spatiotemporal transmission risk"
author: "Nicolas Banholzer"
date: "2022-11-25"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(dplyr.summarise.inform = FALSE)
```

## Libraries

```{r}
library(tidyverse)
library(reshape2)
library(LaplacesDemon)
library(rriskDistributions)
library(tidybayes)
library(lubridate)
library(sf)
library(raster)
library(terra)
library(ggridges)
library(ggplot2)

source("../utils/distr.r")
source("../utils/trans_risk.r")
source("../utils/spatial.r")
source("../utils/plotting.R")
```


## Assumptions

### Spatial emission

* Ko et al. (2004): exponential decrease on an airplane, but they are more strongly ventilated
* Abkarian et al. (2020) deduce that, for the respiratory jet generated by typical speaking, the concentration of pathogen is diminished to approximately 3% of its initial value at a distance of 2 m.
* SSPH report: distance depends on size of aerosols and initial speed, which depends on the activity. For speaking, it will be around 1-2m, for coughing or sneezing it can be up to 7-8m
* Wang et al. (2021) and other studies: viral concentration is highest closest to the source

--> Assume an exponential decrease in viral concentration with distance to source relative to the source (relative concentration = 1). 


```{r}
rMuIc <- function(n) {
  rgamma(n, shape = 10, scale = .2)
}

hist(rMuIc(1e3))

dIc <- function(distance, mu) { 
  1 - pexp(distance, 1 / mu)
}

expand.grid(distance = seq(0, 10, .1), rate = rMuIc(1e3)) %>%
  mutate(dens_inf = dIc(distance, rate)) %>%
  ggplot(aes(x = distance, y = dens_inf)) +
  stat_lineribbon() +
  scale_fill_brewer() +
  scale_x_continuous(expand = c(0,0)) +
  scale_y_continuous(expand = c(0,0)) 
```


### Infectious quanta 

* Catanzaro (1982): 249 quanta/h 
* Nardell (1991): 12.7 quanta/h
* Riley (1962): 1.25 quanta/h but patients already started on chemotheraphy and also few highly infectious patients
* Escombe (2008): 8.2 quanta/h but wide range, including an extreme outlier of 226 quanta/h
* Andrews (2014): 0.44 to 5.69 quanta/h

--> The distribution should roughly reflect the following quantiles
* <1: 10%
* <5: 50%
* <10: 75%
* <50: 95%
* <100: 99%


```{r}
q_a <- c(1, 5, 10, 50, 100, 200)
p_a <- c(.1, .5, .75, .95, .99, 1)
q_range <- seq(0, 200, .1)
p_q_range <- ptrunc(q_range, spec = "st", a = 0, b = 300, mu = 4, sigma = 4, nu = 1)
p_a_selected <- ptrunc(q_a, spec = "st", a = 0, b = 300, mu = 4, sigma = 4, nu = 1)
lnorm_par <- inv_lnorm_moments(5, 10)
p_q_range_lnorm <- plnorm(q_range, meanlog = lnorm_par$meanlog, sdlog = lnorm_par$sdlog)

ggplot(mapping = aes(x = q_range)) +
  geom_line(mapping = aes(y = p_q_range), color = "black") +
  geom_line(mapping = aes(y = p_q_range_lnorm), color = "red") +
  geom_point(mapping = aes(x = q_a, y = p_a_selected), color = "black") +
  geom_point(mapping = aes(x = q_a, y = p_a), color = "blue") +
  scale_x_log10(breaks = q_a) +
  scale_y_continuous(breaks = p_a)

rq <- function(n) {
  rtrunc(n, spec = "st", a = 0, b = 300, mu = 4, sigma = 4, nu = 1)
}

dq <- function(x) {
  dtrunc(x, spec = "st", a = 0, b = 300, mu = 4, sigma = 4, nu = 1)
}

rq_distr <- data.frame(quanta = seq(0, 100, .1)) %>% mutate(prob = dq(quanta))

ggplot(rq_distr, aes(x = quanta, y = prob)) +
  geom_line()
```


### Average volume of exhaled gas

* Richardson et al. (2014): 0.1 - 1.17 l/s per person based on Feher (2017)

```{r}
rV <- function(n) {
  runif(n, 0.1, 0.17)
}
```


### Loss rate due to inactivation

* Nardell (2016) reviews Loudon et al. (1969) and Lever et al. (2000) reporting contradictory findings of half-lives between 20m to 6h. Exact viability in the air is unknown.
* The finding by Lever et al. would suggest that sustained contact is required for transmission.
* The viability in the air probably depends a lot on the conditions, in particular ventilation and UV.  

--> TODO: Check how high the ventilation rate is compared to half-lives as to whether we can ignore the half-lives.


### Loss rate due to deposition onto surfaces

* Wang et al. (2021): The larger the size of the particle, the less long it will reside in the air. Environmental factors such as temperature, humidity and ventilation also play an important role.


### CO2 levels in outdoor air

* https://gml.noaa.gov/dv/data/index.php?site=CPT&parameter_name=Carbon%2BDioxide,%20accessed%2012%20November%202019

```{r}
co2_outdoor <- 412.5
```


### CO2 levels in exhaled air

* Rudnick and Milton (2003): 40,000

```{r}
co2_exhaled <- 40000
```


### CO2 generation rate

* Persily et al.: see Table 5, around 0.003 to 0.005

```{r}
rG <- function(n) {
  runif(n, 0.0041, 0.0055)
}
```

### Unmasked TB patients

* Masked TB patients: TB suspects
* Unmasked TB patients: Poisson(mu = TB suspects)

```{r}
rTBunmasked <- function(n, lambda) {
  rpois(n, lambda)
}
```


## Data

### Clinical

```{r}
# clinical data
clinXov <- readRDS("../data-clean/Masi/merged-clinical-xovis.rds")

yesTB <- clinXov %>%
  filter(tb_suspect=="yes") %>%
  group_by(patient_id) %>%
  slice(1) %>%
  ungroup() 

nTBmasked <- nrow(yesTB)

noTB <- clinXov %>%
  dplyr::filter(ifelse(is.na(tb_suspect), T, ifelse(tb_suspect=="no", T, F))) %>%
  group_by(person_id) %>%
  slice(1) %>%
  ungroup() 

# Time period (for the first day)
time_period <- seq(min(as.POSIXct(format(clinXov$time, "%Y-%m-%d %H:%M"))), 
                   max(as.POSIXct(format(clinXov$time, "%Y-%m-%d %H:%M"))), 
                   by = "min")
```

### Co2

```{r}
# co2
co2 <- readRDS("../data-clean/Masi/environmental-data/co2-levels.rds") %>%
  filter(date == "2021-10-25") 
#' assume waiting area has mean co2 of waiting room and registration
#' passage has co2 of watiing room only
#' tb room has co2 of tb room only
co2 <- co2 %>%
  filter(location %in% c("waiting room", "registration")) %>%
  group_by(date_time) %>%
  summarize(co2 = mean(co2)) %>%
  ungroup() %>%
  mutate(location = "waiting room") %>%
  rbind(co2 %>%
          filter(location == "waiting room") %>%
          mutate(location = "passage") %>%
          dplyr::select(date_time, location, co2)) %>%
  rbind(co2 %>%
          filter(location == "TB room") %>%
          mutate(location = "tb room") %>%
          dplyr::select(date_time, location, co2)) 
ggplot(co2, aes(x = date_time, y = co2, color = location)) + geom_line()
```

### Room

```{r}
# choose cell size such that the squared cell has 1m3 volume
cellVolume <- 1
cellSize <- sqrt(cellVolume * 1e9 / 3e3) 

# waiting room
sh_wr <- vect("../data-raw/Masi/building/waiting_room.shp")
sf_wr <- st_as_sf(sh_wr)
wrRoomSP <- shapeToSpatial(sh_wr, cellSize)
wrVol <- compute_volume(wrRoomSP)
wrCellCoords <- create_coord_df(wrRoomSP)
wrRoomXY <- as.matrix(dplyr::select(wrCellCoords, x, y))

# tb room
sh_tb <- vect("../data-raw/Masi/building/tb_room.shp")
sf_tb <- st_as_sf(sh_tb)
tbRoomSP <- shapeToSpatial(sh_tb, cellSize)
tbVol <- compute_volume(tbRoomSP)
tbCellCoords <- create_coord_df(tbRoomSP)
tbRoomXY <- as.matrix(dplyr::select(tbCellCoords, x, y))

# passage
sh_pa <- vect("../data-raw/Masi/building/passage.shp")
sf_pa <- st_as_sf(sh_pa)
paRoomSP <- shapeToSpatial(sh_pa, cellSize)
paVol <- compute_volume(paRoomSP)
paCellCoords <- create_coord_df(paRoomSP)
paRoomXY <- as.matrix(dplyr::select(paCellCoords, x, y))

# combine
clinicCellCoords <- rbind(
  mutate(wrCellCoords, location = "waiting room"),
  mutate(tbCellCoords, location = "tb room"),
  mutate(paCellCoords, location = "passage")
) %>% mutate(id = 1:nrow(.))
clinicCellCoordsXY <- cbind(clinicCellCoords$x, clinicCellCoords$y)
```


### No. people

```{r}
# number of people in space
nDF <- tibble()
for (tp in time_period) {
  n_tp <- clinXov %>%
    filter(between(time, tp, tp + seconds(59))) %>%
    mutate(location = mapply(function(x,y) clinicCellCoords$location[find_raster(x,y,clinicCellCoordsXY)], x, y)) %>%
    group_by(person_id, location) %>%
    slice(1) %>%
    ungroup() %>%
    group_by(location) %>%
    summarize(n = n()) %>%
    ungroup() 
  for (loc in unique(clinicCellCoords$location)) {
    if (!(loc %in% n_tp$location)) {
      n_tp <- rbind(n_tp, data.frame(location = loc, n = 0))
    } 
  }
  nDF <- rbind(nDF, n_tp %>% mutate(time = tp))
}
nDF <- nDF %>% 
  mutate(time = as.POSIXct(time, origin = as.Date("1970-01-01")))
nDF$n[nDF$location=="waiting room"] <- nDF$n[nDF$location=="waiting room"] + nDF$n[nDF$location=="passage"]
nDF$n[nDF$location=="passage"] <- nDF$n[nDF$location=="waiting room"] + nDF$n[nDF$location=="passage"]
ggplot(nDF, aes(x = time, y = n, color = location)) + geom_line()
```

### Movement

```{r}
patMov <- clinXov %>%
  mutate(id = map2_int(x, y, find_raster, cellCoordsXY = clinicCellCoordsXY))
```


## Simulation

```{r}
# Settings
set.seed(12345)
nSim <- 100

# Input parameters
inputPar <- data.frame(
  spatial_mu = rMuIc(nSim),
  quanta = rq(nSim),
  V = rV(nSim),
  co2_ex = co2_exhaled,
  co2_out = min(co2$co2),
  co2_gen = rG(nSim),
  unmasked_TB = rTBunmasked(nSim, nTBmasked)
)

# Loop
for (s in 1:nSim) {
  message(sprintf("Simulation %i of %i", s, nSim))
  
  # parameters
  smu <- inputPar$spatial_mu[s]
  q <- inputPar$quanta[s]
  V <- inputPar$V[s]
  Ca <- inputPar$co2_ex[s]
  Co <- inputPar$co2_out[s]
  G <- inputPar$co2_gen[s]
  unmasked_TB <- inputPar$unmasked_TB[s]
  
  # transformed parameters
  # quanta emission rate per minute
  ER <- q / 60
  
  # TB patients
  masked_tb <- yesTB$person_id
  unmasked_tb <- sample(noTB$person_id, size = unmasked_TB)
  TBpatients <- patMov %>%
    filter(person_id %in% c(masked_tb, unmasked_tb)) %>%
    dplyr::select(person_id, observation_id, time, x, y) 
  TBpatients_full <- TBpatients %>%
    group_by(person_id) %>%
    summarize(time = list(seq(min(time), max(time), by = "sec"))) %>%
    ungroup() %>%
    unnest(cols = c(time))
  TBpatients_full <- TBpatients_full %>%
    left_join(TBpatients, by = c("person_id", "time")) %>%
    tidyr::fill(observation_id, x, y, .direction = "down")
  
  # no TB patients
  noTBpatients <- patMov %>%
    filter(!(person_id %in% c(masked_tb, unmasked_tb))) %>%
    dplyr::select(person_id, time, id) 
  noTBpatients_full <- noTBpatients %>%
    group_by(person_id) %>%
    summarize(time = list(seq(min(time), max(time), by = "sec"))) %>%
    ungroup() %>%
    unnest(cols = c(time))
  noTBpatients_full <- noTBpatients_full %>%
    left_join(noTBpatients, by = c("person_id", "time")) %>%
    tidyr::fill(id, .direction = "down") %>%
    mutate(time = as.POSIXct(format(time, "%Y-%m-%d %H:%M"))) %>%
    group_by(person_id, id, time) %>%
    summarize(minutes = n() / 60) %>%
    ungroup()
    
  
  # df to store quanta concentration by minute
  quantaDF <- clinicCellCoords %>%
    mutate(time = time_period[1] - minutes(1),
           I_SP = 0,
           I_WM = 0,
           E_SP = 0,
           E_WM = 0,
           N_SP = 0,
           AER = NA,
           RR = NA,
           N_WM = 0,
           N_SP = 0) 
  
  for (t in 1:length(time_period)) {
    
    # time point
    tp <- time_period[t] 
    quantaDF_new <- clinicCellCoords %>%
      mutate(time = tp,
             I_SP = 0,
             I_WM = 0,
             E_SP = 0,
             E_WM = 0,
             N_SP = 0,
             N_WM = 0)
    
    # spatial spread of infectious individuals and quanta emission
    TBpatients_tp <- TBpatients_full %>%
      dplyr::filter(between(time, tp, tp + minutes(1)))
    if (nrow(TBpatients_tp) > 0) {
      TBpatients_tp <- TBpatients_tp %>%
        nest(data = -person_id)
      # iterate over patients
      for (p in 1:nrow(TBpatients_tp)) {
        # duration and location
        duration <- nrow(TBpatients_tp$data[[p]])
        xy <- TBpatients_tp$data[[p]] %>% dplyr::select(x, y) %>% slice(1) %>% unlist()
        # generated quanta by cell
        locationID <- find_raster(xy[1], xy[2], clinicCellCoordsXY)
        locationName <- clinicCellCoords$location[locationID]
        locationCellCoords <- filter(clinicCellCoords, location == locationName)
        locationShape <- if(locationName == "waiting room") {sf_wr} else if(locationName == "tb room") {sf_tb} else {sf_pa}
        cellInReach <- numeric(nrow(quantaDF_new))
        cellDistance <- numeric(nrow(quantaDF_new))
        isIinCell <- ifelse(quantaDF_new$location==locationName, 1, 0 )
        for (cell in 1:nrow(quantaDF_new)) {
          # if cell is in room/location
          if (quantaDF_new$location[cell] != locationName) {
            cellInReach[cell] <- 0
            cellDistance[cell] <- -999
          } else {
            # can aerosols travel to this cell?
            straight_line <- st_linestring(rbind(xy, c(quantaDF_new$x[cell], quantaDF_new$y[cell]))) 
            intersects <- st_difference(straight_line, locationShape)
            cellInReach[cell] <- ifelse(length(intersects) == 0, 1, 0)
            cellDistance[cell] <- convert_dist(st_length(straight_line))
          }
        }
        # proportion of infectious individuals per cell per minute
        distance_dens <- cellInReach * dIc(cellDistance, smu)
        quantaDF_new$I_SP <- quantaDF_new$I_SP + distance_dens / sum(distance_dens) * (duration / 60)
        quantaDF_new$I_WM <- quantaDF_new$I_WM + isIinCell / sum(isIinCell)
      }
      # quanta emission
      quantaDF_new$E_SP <- quantaDF_new$E_SP + ER * quantaDF_new$I_SP
      quantaDF_new$E_WM <- quantaDF_new$E_WM + ER * quantaDF_new$I_WM
    } 
    
    # compute air exchange rate and quanta removal
    Ct <- co2 %>%
      group_by(location) %>%
      # if CO2 is missing, take the last observed value
      filter(date_time <= tp) %>%
      arrange(desc(date_time)) %>%
      slice(1) %>%
      mutate(date_time = tp) %>%
      ungroup() %>%
      # add number of people
      left_join(filter(nDF, time == tp), by = c("date_time" = "time", "location")) %>%
      # add volume
      mutate(vol = ifelse(location == "tb room", tbVol, wrVol + paVol)) %>%
      # compute AER and RR per minute
      mutate(AER = compute_AER(G, Co, co2, n, vol),
             RR = compute_RR(AER) / 60) 
    quantaDF_new <- quantaDF_new %>% 
      left_join(Ct %>% dplyr::select(location, AER, RR), by = "location")
      
    # previous quanta concentration
    N0_SP <- quantaDF %>% 
      filter(time == tp - minutes(1)) %>%
      dplyr::select(N_SP) %>% unlist
    N0_WM <- quantaDF %>% 
      filter(time == tp - minutes(1)) %>%
      dplyr::select(N_WM) %>% unlist
    
    # compute quanta concentration
    quantaDF_new$N_SP <- pmap_dbl(list(E = quantaDF_new$E_SP, 
                                       RR = quantaDF_new$RR, 
                                       N0 = N0_SP,
                                       V = cellVolume), compute_Nt)
    quantaDF_new$N_WM <- pmap_dbl(list(E = quantaDF_new$E_WM, 
                                       RR = quantaDF_new$RR, 
                                       N0 = N0_WM,
                                       V = cellVolume), compute_Nt)
    
    # append new data
    quantaDF <- rbind(quantaDF, quantaDF_new)
  }
  
  # compute (spatio)temporal transmission risk for each individual
  risk_of_infection <- noTBpatients_full %>%
    left_join(quantaDF, by = c("id", "time")) %>%
    group_by(person_id) %>%
    summarize(exposure_time = sum(minutes),
              P_SP = 1-exp(-sum(N_SP * minutes)),
              P_WM = 1-exp(-sum(N_WM * minutes))) %>%
    ungroup()
  
  # compute average transmission risk
  sum_I <- data.frame(location = c("waiting room", "passage", "tb room"),
                      I = length(c(masked_tb, unmasked_tb))) 
  mean_n <- nDF %>% 
    group_by(location) %>%
    summarize(n = median(n) + 1) %>%
    ungroup()
  mean_f <- co2 %>%
    group_by(location) %>%
    summarize(f = (mean(co2) - Co) / Ca) %>%
    ungroup()
  risk_of_infection_av <- noTBpatients_full %>%
    left_join(quantaDF %>% dplyr::select(id, time, location), by = c("id", "time")) %>%
    group_by(person_id, location) %>%
    summarize(minutes = sum(minutes)) %>%
    ungroup() %>%
    left_join(sum_I, by = "location") %>%
    left_join(mean_n, by = "location") %>%
    left_join(mean_f, by = "location") %>%
    mutate(mu = f * I * ER * minutes / n) %>%
    group_by(person_id) %>%
    summarize(P_SS = 1 - exp(-sum(mu))) %>%
    ungroup()
  risk_of_infection <- risk_of_infection %>%
    left_join(risk_of_infection_av, by = "person_id")
  
  
  # save simulation
  saveRDS(quantaDF, paste0("../simulations/2021-10-25/sim-quanta", s, ".rds"))
  saveRDS(risk_of_infection, paste0("../simulations/2021-10-25/sim-transRisk", s, ".rds"))
}
```



## Evaluation

### TB risk

```{r}
# files
transRiskFiles <- list.files("../simulations/2021-10-25", full.names = T)
transRiskFiles <- transRiskFiles[grepl("transRisk", transRiskFiles)]

# read files
transRiskDF <- data.frame(file = transRiskFiles) %>%
  mutate(simulation = stringi::stri_extract(basename(file), regex = "\\d{1,4}"), 
         data = lapply(file, readRDS)) %>%
  unnest(cols = c(data))

# QQ Plot
transRiskDF_Q <- transRiskDF %>%
  dplyr::select(simulation, P_SP, P_WM) %>%
  melt("simulation") %>%
  group_by(simulation, variable) %>%
  summarize(quantile = seq(0.05, .95, 0.05),
            value = quantile(value, seq(0.05, 0.95, 0.05))) %>%
  ungroup()

transRiskDF_Q_av <- transRiskDF_Q %>%
  group_by(variable, quantile) %>%
  summarize(value = mean(value)) %>%
  ungroup()

transRiskDF_Q_av %>%
  ggplot(aes(x = quantile, y = value, color = variable)) +
  geom_line()

# average transmission risk across patients
average_tr <- transRiskDF %>%
  dplyr::select(simulation, P_SP, P_WM) %>%
  mutate(P_SP = P_SP * 100,
         P_WM = P_WM * 100) %>%
  melt("simulation") %>%
  group_by(simulation, variable) %>%
  summarize(`Mean` = mean(value),
            `Standard deviation` = sd(value),
            `Median` = median(value),
            `Tail risk (95%-Quantile)` = quantile(value, .95)) %>%
  ungroup() 

figA <- average_tr %>%
  rename(model = variable) %>%
  mutate(model = ifelse(model == "P_SP", "Spatiotemporal modeling", "Temporal modeling")) %>%
  melt(c("simulation", "model")) %>%
  ggplot(aes(x = value, y = model, fill = model, color = model)) +
  stat_dots(quantiles = 100) +
  facet_wrap(~ variable, scales = "free_x") +
  scale_color_manual(values = cbPalette[2:3]) +
  scale_fill_manual(values = cbPalette[2:3]) +
  labs(x = "Risk of infection (%)", 
       title = "Fig. 1a: Risk of infection across patients",
       subtitle = "Colored dots show individual simulation results.") +
  theme_bw2() +
  theme(legend.position = "top", axis.title.y = element_blank(), axis.text.y = element_blank(), legend.title = element_blank(),
        legend.justification='left', legend.direction='horizontal')

figA

average_tr %>%
  dplyr::select(-simulation) %>%
  group_by(variable) %>%
  median_qi() %>%
  mutate_if(is.numeric, round, 2)


figB <- transRiskDF %>%
  ggplot(aes(x = P_SP, y = P_WM)) +
  geom_point(shape = 1) +
  geom_abline(mapping = aes(intercept = 0, slope = 1), color = "red", linetype = "dashed") +
  annotate("richtext", x = 0.75, y = 0.82, 
           label = "<span style = 'background-color:#fff'>Perfect correlation</span>", 
           size = 8 / cm(1), color = "red", angle = 22, label.color = NA) +
  geom_smooth(method = "lm") +
  annotate("richtext", x = 0.85, y = 0.55, 
           label = "<span style = 'background-color:#fff'>Empirical correlation</span>", 
           size = 8 / cm(1), color = "blue", angle = 16, label.color = NA) +
  labs(x = "Risk of infection (%) with spatiotemporal modeling", 
       y = "Risk of infection (%) with temporal modeling",
       title = "Fig. 1b: Patient-specific risk of infection",
       subtitle = "One dot per patient and simulation. Dots off (on) the diagonal imply a (no) differing risk of infection by modeling.") +
  scale_x_continuous(expand = c(0,0), limits = c(0,1), label = function(x) x * 100) +
  scale_y_continuous(expand = c(0,0), limits = c(0,1), label = function(x) x * 100) +
  theme_bw2() +
  theme(plot.margin = unit(c(5.5, 7.5, 5.5, 5.5), "points"))

figB

ggsave("../results/model-comparison.png", grid.arrange(figA, figB, ncol = 1), width = 16 / cm(1), height = 16 / cm(1))

# visualization of spatial approach
transRriskSP_pl <- transRiskDF %>%
  mutate(P_SP = P_SP * 100) %>%
  ggplot(aes(x = P_SP, y = simulation)) + # , color = ..x..
  stat_dots(quantiles = 20, color = "black") +
  #scale_color_viridis() +
  labs(y = "Simulation", x = "Risk of infection (%)",
       title = "Figure 1: Risk of infection", subtitle = "Quantile distribution of patient-specific risk of infection (%) for each simulation") +
  scale_x_sqrt(limits = c(0,NA), expand = c(0,0)) +
  scale_y_discrete(expand = c(0,0)) +
  theme_bw2() +
  theme(legend.position = "none")

transRriskSP_pl


# low, medium, high risk
transRiskDF_cat <- transRiskDF %>%
  dplyr::select(simulation, P_SP, P_WM) %>%
  melt("simulation") %>%
  group_by(simulation, variable) %>%
  summarize(`Very low` = sum(value <= .01),
            Low = sum(value > .01 & value <= .05),
            Medium = sum(value > .05 & value <= .1),
            High = sum(value > .1 & value <= .5),
            `Very high` = sum(value > .5)) %>%
  ungroup()


figB <- transRiskDF_cat %>%
  rename(model = variable) %>%
  mutate(model = factor(ifelse(model == "P_SP", "Spatiotemporal modeling", "Temporal modeling"),
                        levels = c("Spatiotemporal modeling", "Temporal modeling"))) %>%
  melt(c("simulation", "model")) %>%
  group_by(model, variable) %>%
  summarize(value = mean(value)) %>%
  ungroup() %>%
  ggplot(aes(y = variable, fill = model, x = value)) +
  geom_bar(stat = "identity", position = position_dodge2()) +
  scale_x_log10(expand = c(0,0)) + 
  scale_fill_manual(values = cbPalette[c(2,1)]) +
  labs(title = "B | Average number of visitors by risk of infection",
       subtitle = "Number of visitors with very high (>50%), high (10-50%), medium (5-10%), low (1-5%), and very low (<1%) risk of infection.",
       x = "Number of visitors") +
  theme_bw2() +
  theme(legend.position = "top", legend.justification='left', legend.direction='horizontal',
        legend.title = element_blank(), legend.key.width = unit(2.5, "cm"),
        axis.title.y = element_blank(),
        plot.title.position = "plot")

figB

transRiskDF_cat_alt <- transRiskDF %>%
  dplyr::select(simulation, P_SP, P_WM) %>%
  melt("simulation") %>%
  group_by(simulation, variable) %>%
  summarize(Low = sum(value <= .1),
            Medium = sum(value > .1 & value <= .5),
            High = sum(value > .5)) %>%
  ungroup()

figB_alt <- transRiskDF_cat_alt %>%
  rename(model = variable) %>%
  mutate(model = factor(ifelse(model == "P_SP", "Spatiotemporal modeling", "Temporal modeling"),
                        levels = c("Spatiotemporal modeling", "Temporal modeling"))) %>%
  melt(c("simulation", "model")) %>%
  group_by(model, variable) %>%
  summarize(value = mean(value)) %>%
  ungroup() %>%
  ggplot(aes(y = variable, fill = model, x = value)) +
  geom_bar(stat = "identity", position = position_dodge2()) +
  scale_x_log10(expand = expansion(mult = c(0,.01))) + 
  scale_fill_manual(values = cbPalette[c(2,1)], breaks = c("Temporal modeling", "Spatiotemporal modeling")) +
  labs(title = "B | Estimated number of visitors by risk of infection",
       subtitle = "Average number of visitors with high (>50%), medium (10-50%), and low (<10%) risk of infection.",
       x = "Number of visitors") +
  theme_bw2() +
  theme(legend.position = c(0.675, 0.825), legend.justification='left', legend.direction='vertical',
        legend.title = element_blank(), legend.key.width = unit(1.5, "cm"),
        axis.title.y = element_blank(),
        plot.title.position = "plot")

figB_alt
```


### Quanta 

```{r}
# files
quantaFiles <- list.files("../simulations/2021-10-25", full.names = T)
quantaFiles <- quantaFiles[grepl("quanta", quantaFiles)]

# read files
quantaDF <- data.frame(file = quantaFiles) %>%
  mutate(simulation = stringi::stri_extract(basename(file), regex = "\\d{1,4}"), 
         data = lapply(file, readRDS)) %>%
  unnest(cols = c(data))

# average quanta concentration
quantaDF_av <- quantaDF %>%
  filter(location == "waiting room") %>%
  # mutate(daytime = ifelse(time <= "2021-10-25 11:00:00", "Morning", 
  #                         ifelse(time <= "2021-10-25 13:00:00", "Noon", "Afternoon"))) %>%
  mutate(daytime = ifelse(time <= "2021-10-25 12:00:00", "Morning", "Afternoon")) %>%
  group_by(daytime, id) %>%
  summarize(N_SP = mean(N_SP)) %>%
  ungroup()

wrRoomSP_df <- fortify(wrRoomSP) %>%
  left_join(quantaDF_av %>% mutate(id = as.character(id)), by = "id") 

figA <- wrRoomSP_df %>%
  # mutate(daytime = factor(daytime, c("Morning", "Noon", "Afternoon"))) %>%
  mutate(daytime = factor(daytime, c("Morning", "Afternoon"))) %>%
  ggplot(aes(x = lat, y = long, group = group, fill = N_SP)) +
  geom_polygon() +
  facet_wrap(~ daytime) +
  scale_fill_gradient(low = "yellow", high = "red", na.value = NA) +
  labs(title = "A | Estimated spatiotemporal quanta concentration in the clinic by daytime",
       # subtitle = "Quanta concentration (quanta/m3) in the morning (7:30 to 11am), noon (11am to 1pm), and afternoon (1 to 4pm).") +
       subtitle = "Average quanta concentration (quanta/m3) in the morning (7:30 to 12am) and afternoon (12am to 4pm).") +
  geom_path(color = "white", size = 0.2) +
  theme_bw2() +
  theme(axis.title = element_blank(), axis.text = element_blank(),
        legend.position = "top", legend.justification='left', legend.direction='horizontal',
        legend.title = element_blank(), legend.key.width = unit(2.5, "cm"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank())

figA

ggsave("../results/model-comparison.png", grid.arrange(figA, figB_alt, ncol = 1), width = 16 / cm(1), height = 16 / cm(1))
```

